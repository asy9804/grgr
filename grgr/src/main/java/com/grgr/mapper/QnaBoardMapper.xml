<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.grgr.mapper.QnaBoardMapper">
	
	<!-- 게시글 페이지 검색 >> infoboard 참고하여 하기 구문으로 변경
	<select id="selectQnaBoard" resultType="QnaBoard">
		select qna_bno, uno, qna_keyword, qna_title, qna_content from qna_board 
		where qna_blindstate=1
			and (qna_title like '%'||#{qna_title}||'%' 
				or qna_content like '%'||#{qna_content}||'%')
	</select>
	 -->
	
	<!-- 검색 조건문 -->
	<!-- TC:제목+내용, T: 제목, W: 작성자, -->
	<sql id="search">
		<trim prefix="(" suffix=") AND " prefixOverrides="OR">
			<choose>
				<when test="searchType == 'TC'.toString()">
					qna_title like '%'||#{keyword}||'%' OR qna_content like '%'||#{keyword}||'%'
				</when>
				<when test="searchType == 'T'.toString()">
					qna_title like '%'||#{keyword}||'%'
				</when>
				<!-- <when test='searchType == "W"'>
					writer like '%'||#{keyword}||'%'
				</when> -->
			</choose>
		</trim>
	</sql>

	<!-- 게시글 삽입 -->
	<insert id="insertQnaBoard">
		<selectKey resultType="int" keyProperty="qnaBno" order="BEFORE">
			select qna_bno_seq.nextval 
			from dual 
		</selectKey>
		insert into qna_board values(#{qnaBno}, #{uno}, #{qnaKeyword}, #{qnaTitle}
			, #{qnaContent}, #{qnaViewCnt}, #{qnaBlindstate}, SYSDATE
			, SYSDATE, #{qnaUpdateUno})
	</insert>	
	
	<!-- 게시글 수정 -->
	<update id="updateQnaBoard">
		update qna_board set qna_keyword=#{qnaKeyword}
			, qna_title=#{qnaTitle}, qna_content=#{qnaContent}
				, qna_blindstate=#{qnaBlindstate},qna_modifydate=SYSDATE 
				,qna_update_uno=#{qnaUpdateUno}
		where qna_bno=#{qnaBno} and uno=#{uno}
	</update>
	
	<!-- 게시글 삭제 -->
	<delete id="deleteQnaBoard">
		delete 
		from qna_board=3 
		where qna_bno=#{qnaBno}
	</delete>
	 
	<!-- 총게시글 수 -->
	<select id="qnaBoardCount" resultType="int">
		select count(*) from qna_board where <if test='keyword!=null and keyword != ""'><include refid="search"></include></if>
		qna_blindstate=1

	</select>
	 
	<!-- n번 게시글 -->
	<select id="selectQnaBoard" resultType="QnaBoard">
		select qna_bno, uno,
		qna_keyword, qna_title, qna_content, qna_view_cnt, qna_blindstate, qna_regdate
			, qna_update, qna_update_uno 
		from qna_board
		where qna_bno=#{qnaBno}
	</select>
	
	<!-- 이전 글 번호 찾기 -->
	<select id="selectPrevInfoBno" resultType="Integer">
		select max(qna_bno)
		from qna_board where qna_bno &lt; #{qnaBno} and qna_blindstate = 1
	</select>

	<!-- 다음 글 번호 찾기 -->
	<select id="selectNextInfoBno" resultType="Integer">
		select min(qna_bno)
		from qna_board where qna_bno &gt; #{qnaBno} and qna_blindstate = 1
	</select>
	
	<!-- 총 게시글 개수 검색 
	<select id="selectQnaBoardCount" resultType="int">
		select count(*) 
		from qna_board
	</select>
	-->
	
	<!-- 게시글 목록 검색 -->
	<select id="selectQnaBoardList" resultType="QnaBoard">
		select * 
		from (select ROWNUM rn, board.* 
			from(select qna_bno, uno, qna_keyword, qna_title, qna_content, qna_view_cnt 	
				, qna_blindstate, qna_regdate, qna_modifydate, qna_update_uno 
				from qna_board 
				where qna_blindstate=1 
					and (qna_title like '%'||#{qnaTitle}||'%'
						or qna_content like '%'||#{qnaContent}||'%') 
				order by qna_bno) 
			board)
		 where rn between #{startRow} and #{endRow}
	</select>
	
	<!-- 조회수 증가 -->
	<update id="increaseQnaViewCnt">
		update qna_board set qna_view_cnt = qna_view_cnt+1
		where qna_bno=#{qnaBno}
	</update>
</mapper>
